# ADR‑0003 — Multi‑step “Add New Site” and Onboarding Tabs

**Date:** 2025‑09‑10  
**Owner:** Sunghyun Cho  
**Status:** Accepted  
**Decision Scope:** UX flow for creating a site and first‑run onboarding inside the app.

## Context

The previous “Add New Site” page mixed creation and integration instructions in a single, crowded view. Feedback: it felt “ugly” and overwhelming. We need a clearer, low‑friction path to:

- Create a site record quickly with just the root URL (name optional).  
- Then guide users to send the first signal from their website via concise, icon‑backed instructions.

This aligns with ADR‑0001’s server‑first design and ingest model.

## Decision

Adopt a two‑step flow:

1) Site creation (minimal)
- Collect only “Website URL” and optional name.  
- Normalize URL to origin and create a `pages` row scoped to the current org.  
- Redirect to the site detail page.

2) First‑run onboarding on the site page
- When no transform exists for the page (status inferred as “new”), display onboarding instructions in tabs with icons.  
- Provide two options: a Script Tag snippet and a React component snippet.  
- Keep copy short; emphasize where to paste, and that opening the site will send the first signal.

Behavioral notes:
- Uses `await auth()` for org scoping. If no org is active, redirect to `/sites`.  
- Ingest/domain verification stays unchanged (localhost allowed; production domains must be verified before ingest succeeds).

## Implementation

- New‑site UX
  - `apps/app/src/app/(app)/sites/new/page.tsx` — simplified form: URL + optional name;
  - `apps/app/src/app/(app)/sites/new/route.ts` — POST handler to validate/normalize URL, upsert a `pages` row, and redirect to `/site/[id]`.

- Onboarding on site page
  - `apps/app/src/app/(app)/site/[id]/OnboardingTabs.tsx` — Headless UI Tabs with icon labels and copyable snippets.
  - `apps/app/src/app/(app)/site/[id]/page.tsx` — if no transforms exist, render onboarding section instead of metrics.

- Auth + TypeScript
  - Standardized server usage to `const { orgId } = await auth()` where applicable.  
  - Raised TS target to ES2020 to support BigInt used by `simhash`.

No database schema changes were required.

## Alternatives Considered

- Keep integration snippets on the creation page: rejected — higher cognitive load; mixes intents.  
- Full client‑side wizard/multi‑step modal: unnecessary complexity; server redirect is simpler and URL‑shareable.  
- Gate creation on domain verification: deferred — verification remains enforced at ingest time.

## Consequences

- Faster site creation with less UI noise.  
- Clear, discoverable onboarding directly in the site’s context.  
- Minimal code surface: one POST route and a small client component.  
- Slight TS config bump (ES2020) to maintain existing BigInt usage.

## Security & Privacy

- No secrets in the browser; ingest stays server‑side per ADR‑0001.  
- Domain verification still required for non‑localhost signals.  
- “YOUR_ORG_ID” appears only in UI placeholders; server actions require `await auth()` and active org.

## Rollout

- Already deployed in app code paths noted above.  
- No migrations or data backfills.  
- Future refinement: add copy‑to‑clipboard and success toasts; optionally surface domain verification hints here.

