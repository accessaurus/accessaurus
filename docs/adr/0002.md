# ADR‑0002 — SDK Ingest, Client Apply, Review UI, and Publish

Date: 2025‑09‑10
Status: Accepted
Owners: Sunghyun Cho
Related: ADR‑0001 (Semantic HTML Transformer Architecture)

## Context

We pivoted Accessaurus to automatically upgrade div‑soup into semantic, accessible HTML. To prove the approach end‑to‑end we needed:

- A zero‑friction way for sites to send page content to our server.
- Deterministic dedupe to avoid repeated model work on unchanged pages.
- A reliable transform path (heuristics first, LLM optional) with guardrails.
- A review step to approve/reject server outputs before rollout.
- A demo and CI path for SDK distribution.

## Decision

Ship a browser SDK + React tag that collects the page, computes a perceptual hash, and POSTs to a server ingest API. The server transforms the HTML (heuristics by default; LLM behind a flag), stores the transformed HTML plus a unified diff patch, and exposes an API to fetch the latest result. A Review UI in the dashboard allows approve/reject. The SDK is published via GitHub Actions on `sdk-v*` tags.

Key choices:
- SDK sends two HTML variants:
  - skeleton: scripts/styles/classes removed → used only for SimHash and caching.
  - html: preserves class/id/role → used for semantic transformation so heuristics have strong signals.
- Idempotency: cache key `(orgId, pageId, inputHash)` skips work when content hasn’t changed.
- Domain gating: only accept ingest from verified domains (localhost allowed in dev).
- CORS: first‑class preflight support and explicit allow headers for cross‑origin SDK calls.
- Client apply (demo): optional immediate apply that polls for the latest result and swaps the page body while preserving styles.

## Architecture & APIs

Data flow:
1) Browser loads the SDK snippet (or React tag) and collects the document.
2) Compute SimHash on skeleton, send `{ orgId, pageUrl, skeleton, html, hash }` → `POST /api/sdk/ingest`.
3) Server validates input, domain gate, idempotency check, runs transform engine, stores outputs and changes.
4) Client (optional) polls `GET /api/sdk/latest?orgId&pageUrl&hash` and applies the upgraded HTML.

APIs:
- `POST /api/sdk/ingest`
  - Input: `{ orgId, pageUrl, html, skeleton?, hash? }`
  - Behavior: domain gating (except localhost), cache by SimHash, run engine → store `{ html, patch }` with change log; compute metrics (coverage, landmarks, headings).
- `GET /api/sdk/latest`
  - Returns latest transformed output for org/page/hash; CORS enabled; used by demo/“apply immediately”.
- `GET /api/sdk/snippet`
  - Serves the browser snippet; Cache‑Control: `no-store` to avoid stale client code during iteration.

Engine:
- Heuristics (default): conservative role/id/class mapping to `header/nav/main/section/article/aside/footer`, anchor→button where appropriate, `figure/figcaption`, and `time[datetime]`.
- LLM (optional): provider switch via `SEMANTIFY_LLM_PROVIDER=openai|ollama`; JSON‑bounded output with Zod; disabled by default.

SDK behavior:
- Absolute endpoint fallback: if `data-endpoint` is not provided, derive the ingest origin from the snippet’s own `src` origin (prevents wrong port on demo).
- Retry on apply: after ingest resolves, poll `latest` (10x, 300ms) to eliminate races between ingest completion and fetch.
- Preserve styles on apply: clone `style` and `link[rel=stylesheet]` nodes inside body before replace, and reattach after replacing `document.body.innerHTML`.

## Review UI & Data Model

DB additions:
- `transforms.review_status` (enum: pending|approved|rejected), `reviewer_id`, `reviewed_at`.

Review endpoints:
- `POST /api/review/:id/approve`, `POST /api/review/:id/reject` (Clerk auth; org scoped).

Pages:
- My Sites list: `/sites`, detail: `/site/:id` (latest status, metrics, and transform list).
- Review page: `/site/:id/review/:tid` shows patch + per‑change log with approve/reject.
- Navigation updated to “My Sites”; legacy “websites/events/orders” pages removed.

## Packaging & CI

- SDK package: `packages/sdk` (exports snippet, React tag, and helpers; `dist` via `tsc`).
- Publish GH Action: `.github/workflows/publish-sdk.yml` builds and publishes on `sdk-v*` tags with `NPM_TOKEN`.

## Demo

- Static demo site at `apps/demo` (Bun server on `:3200`) includes the snippet and renders a div‑soup page.
- By default, the snippet loads from `http://localhost:3000/api/sdk/snippet` and applies the transformed HTML (style‑preserving).

## Consequences

- Slightly larger SDK payload (sends both skeleton + html) but enables accurate transforms.
- Client apply is for demo; production rollouts should rely on review + server integration.
- Domain gating + CORS reduce abuse and prevent mis‑configured origins.
- Retry loop removes flakiness from races; idempotency reduces compute.

## Alternatives Considered

- Transforming skeleton only → rejected (loses vital class/role/id signals).
- Apply without polling → flaky due to write/read race; polling chosen for robustness.
- One LLM provider → rejected; provider switch enables flexibility and cost/perf tuning.

## Next Steps

- Domain Verification UI (token generation + verification flow).
- Review UI enhancements: side‑by‑side visual diff; mark approved transform as active.
- Metrics dashboard: semantic coverage trends, landmarks presence, heading outline.
- Server‑side “apply” integration path for SSR/SSG (avoid client swapping in production).
- SDK reliability: configurable retry/backoff; optional preserve list for runtime nodes.
