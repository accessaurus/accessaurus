# ADR‑0004 — Site Creation Flow: Add New Site handler and routing fix

**Date:** 2025‑09‑10  
**Owners:** Accessaurus Team  
**Decision Scope:** Implement a server‑first site creation flow for the “Add New Site” page that creates or reuses a page record, and fix the routing causing 405 on GET.

## Context & Problem

The “Add New Site” UI at `/sites/new` did not persist data. A route handler placed directly at `/sites/new` would also shadow the page and return 405 for GET (no GET implemented). Contributors and users need a reliable way to create a page record (org‑scoped) and land on its detail view.

## Decision Summary

1. Use a nested POST route at `/sites/new/submit` to avoid shadowing the page route, and update the form `action` to post there.
2. Server‑side creation is org‑scoped via Clerk `orgId`, with idempotent dedupe by `(orgId, url)` so repeated submissions don’t create duplicates.
3. On success, redirect to `/site/{id}` (303 See Other) for continuity into the site details and metrics.
4. Keep the flow dependency‑free and avoid DB schema changes.

## Architecture (Implementation)

- UI: `apps/app/src/app/(app)/sites/new/page.tsx`
  - `<form method="post" action="/sites/new/submit">` with fields `url` (required) and `name` (optional).
- Handler: `apps/app/src/app/(app)/sites/new/submit/route.ts`
  - Auth: uses Clerk `orgId`; returns 401 without it.
  - Validates the URL format.
  - Upsert pattern: select page by `(orgId, url)`; if absent, insert with `{ orgId, url, title: name || null, type: 'site', contentHash: 'init' }`.
  - Redirect: 303 to `/site/{id}`.
- Removed the conflicting top‑level `route.ts` under `/sites/new` that caused GET 405.

## Security & Privacy

- Org scoping enforced via Clerk. No cross‑tenant creation.
- Only basic URL validation is performed server‑side; no external fetches are made.
- No secrets or tokens are processed. The request is form‑data only.

## Consequences

- Users can create or reuse a site record and land immediately on the per‑page dashboard.
- No new tables or migrations; the implementation writes to existing `pages`.
- A small convention: place POST handlers under `/submit` to avoid shadowing page routes in the App Router.

## Alternatives Considered

- JSON API under `/api/sites`: more generic, but requires client JS or a separate fetch; we prioritized a zero‑JS form submission.
- Keeping `/sites/new/route.ts`: rejected due to GET shadowing and 405 for the page.
- Auto‑creating a domain verification record: deferred to keep scope small; this can be added as a follow‑up.

## Next Steps

1. Optional: create a `domains` row (verified: false) with a generated token on site creation to streamline verification.
2. Validate ownership/host format rules (e.g., forbid wildcards or unsupported schemes) and normalize URLs.
3. Add UI feedback for duplicate URL submissions within the same org.
4. Add basic integration tests for the route and redirect behavior.

